# lighttpd configuration for 3DS Backup Dashboard
# Serves static dashboard files and backup downloads

server.modules = (
    "mod_access",
    "mod_alias",
    "mod_dirlisting",
    "mod_staticfile",
)

# ── Basic server settings ──────────────────────────────────────────────────────
server.port             = 80
server.bind             = "0.0.0.0"

server.document-root    = "/var/lib/backup_3ds/dashboard/static"
server.upload-dirs      = ( "/tmp" )

server.errorlog         = "/var/log/lighttpd/error.log"
accesslog.filename      = "/var/log/lighttpd/access.log"

server.pid-file         = "/var/run/lighttpd.pid"

# Run as a low-privilege user (adjust to your system)
server.username         = "www-data"
server.groupname        = "www-data"

# ── MIME types ─────────────────────────────────────────────────────────────────
mimetype.assign = (
    ".html"    => "text/html",
    ".htm"     => "text/html",
    ".css"     => "text/css",
    ".js"      => "application/javascript",
    ".json"    => "application/json",
    ".png"     => "image/png",
    ".jpg"     => "image/jpeg",
    ".jpeg"    => "image/jpeg",
    ".gif"     => "image/gif",
    ".svg"     => "image/svg+xml",
    ".ico"     => "image/x-icon",
    ".woff"    => "font/woff",
    ".woff2"   => "font/woff2",
    ".ttf"     => "font/ttf",
    # 3DS backup / archive formats — served as binary downloads
    ".zip"     => "application/zip",
    ".7z"      => "application/x-7z-compressed",
    ""         => "application/octet-stream",
)

# ── Static dashboard (document root, served at /) ─────────────────────────────
# Files are served directly from /var/lib/backup_3ds/dashboard/static
# Index file for the dashboard SPA / landing page
index-file.names = ( "index.html", "index.htm" )

# ── Backup downloads (served at /downloads) ───────────────────────────────────
alias.url = (
    "/downloads" => "/var/lib/backup_3ds/backups",
)

# Enable directory listing under /downloads so users can browse backup files
$HTTP["url"] =~ "^/downloads($|/)" {
    dir-listing.activate      = "enable"
    dir-listing.hide-dotfiles = "enable"
    dir-listing.encoding      = "utf-8"
}

# ── Security ──────────────────────────────────────────────────────────────────
# Block access to hidden files / directories (dot-files)
$HTTP["url"] =~ "/\." {
    url.access-deny = ( "" )
}

# Deny directory listing everywhere except /downloads
$HTTP["url"] !~ "^/downloads($|/)" {
    dir-listing.activate = "disable"
}
